---
title: "Converting scRNA-seq and scATAC-seq data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Converting scRNA-seq and scATAC-seq data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Setup

```{r setup}
pkgload::load_all(helpers = FALSE)
library(fs)
library(tiledb)
library(Seurat)
library(SeuratData)

data_dir <- file.path(tempdir(), "vignette-data")
dir.create(data_dir, showWarnings = FALSE)
```

## Load data

```{r}
if (requireNamespace("pbmcMultiome", quietly = TRUE)) {
  message("Installing pbmcMultiome")
  SeuratData::InstallData("pbmcMultiome")
}
```

```{r}
pbmc.rna <- LoadData("pbmcMultiome", "pbmc.rna")
```

Feature-level annotations are empty for this dataset. To aid in testing we add an `ensembl_id` column containing Ensembl identifiers.

```{r}
suppressPackageStartupMessages(library(org.Hs.eg.db))

var_df <- GetAssay(pbmc.rna)[[]]

var_df$ensembl_id <- unname(
  mapIds(
    org.Hs.eg.db,
    keys = rownames(var_df),
    keytype = "SYMBOL",
    column = "ENSEMBL",
    multiVals = "first"
  )
)

pbmc.rna@assays$RNA@meta.features <- var_df
```

# Step-by-step Conversion from Seurat to a TileDB `sc_group`

Create URIs for each of the 3 arrays that will make up the new `sc_group`:

```{r}
sc_group_uris <- sapply(c("X", "obs", "var"), \(x) file.path(data_dir, x))
sc_group_uris
```

## RNA Counts

Create a new instance of `SCGroup_X` and specify its location.

```{r}
scgroup_x <- SCGroup_X$new(array_uri = sc_group_uris[["X"]])
```

Retrieve a count matrix from the Seruat `Assay` object and ingest it into the `X` array of the `sc_group`.

```{r}
scgroup_x$from_matrix(
  x = GetAssayData(object = pbmc.rna, slot = "counts")
)
```

Examine the contents of the newly created `X` array.

```{r}
fs::dir_tree(scgroup_x$array_uri)
```

Data stored in the `X` array can then be loaded back into R in the same `dGTMatrix` format:

```{r}
scgroup_x$to_matrix()
```

## Feature (variable) annotations

Both `var` and `obs` annotations are handled by the same `SCGroup_Annotation` class.

Create one instance of `SCGroup_Annotation` for the variable annotations:

```{r}
scgroup_var <- SCGroup_Annotation$new(array_uri = sc_group_uris[["var"]])
```

Ingest the `data.frame` containing the RNA assay's feature annotations into the `var` array.

```{r}
scgroup_var$from_dataframe(
  x = GetAssay(pbmc.rna, assay = "RNA")[[]]
)
```

Examine the contents of the newly created `var` array.

```{r}
fs::dir_tree(scgroup_var$array_uri)
```

Retrieve the feature annotations from the `var` array:

```{r}
scgroup_var$to_dataframe()
```

## Observation (sample) annotations

Create a second instance of `SCGroup_Annotation` for the observation annotations:

```{r}
scgroup_obs <- SCGroup_Annotation$new(array_uri = sc_group_uris[["obs"]])
```

Ingest `data.frame` containing observation annotations into the `obs` component.

```{r}
scgroup_obs$from_dataframe(
  x = pbmc.rna[[]]
)
```

Retrieve the observation annotations from the `obs` array:

```{r}
scgroup_obs$to_dataframe()
```

# Convert Seurat object to TileDB-backed sc_group

Now we'll use the higher-level `SCGroup` class to handle the entire conversion process from a `Seurat` object to a TileDB `sc_group`.

First, create the empty group:

```{r}
scgroup_uri <- file.path(data_dir, "sc_group")
scgroup <- SCGroup$new(array_uri = scgroup_uri)

fs::dir_tree(scgroup_uri)
```

Then pass the `pmbc.rna` object to the `from_seurat` method of the `SCGroup` class:

```{r}
scgroup$from_seurat(object = pbmc.rna, assay = "RNA")
```

Examine the directory structure of the `sc_group`:

```{r}
fs::dir_tree(scgroup_uri)
```

From the TileDB `sc_group` we can load the data back into memory as either a _Seurat_ `Assay` object

```{r}
scgroup$to_seurat_assay()
```

or as a `Seurat` object:

```{r}
scgroup$to_seurat_object(project = "SCGroup Example", assay = "RNA")
```

# Session

```{r}
sessionInfo()
```

```{r cleanup, include=FALSE}
tiledb::tiledb_vfs_remove_dir(data_dir)
```
