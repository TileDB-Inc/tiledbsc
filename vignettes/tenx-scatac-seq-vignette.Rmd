---
title: "Converting scRNA-seq and scATAC-seq data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Converting scRNA-seq and scATAC-seq data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Setup

```{r setup}
pkgload::load_all(helpers = FALSE)
library(tiledb)
library(Seurat)
library(SeuratData)

data_dir <- tempdir()
```

# Load data

```{r}
if (requireNamespace("pbmcMultiome", quietly = TRUE)) {
  message("Installing pbmcMultiome")
  SeuratData::InstallData("pbmcMultiome")
}
```

```{r}
pbmc.rna <- LoadData("pbmcMultiome", "pbmc.rna")
```

Feature-level annoations are empty for this dataset. To aid in testing we add an `ensembl_id` column containing Ensembl identifiers.

```{r}
suppressPackageStartupMessages(library(org.Hs.eg.db))

var_df <- GetAssay(pbmc.rna)[[]]

var_df$ensembl_id <- unname(
  mapIds(
    org.Hs.eg.db,
    keys = rownames(var_df),
    keytype = "SYMBOL",
    column = "ENSEMBL",
    multiVals = "first"
  )
)

pbmc.rna@assays$RNA@meta.features <- var_df
```

# Step-by-step Conversion

Create URIs for each of the 3 arrays in the `sc_group`:

```{r}
sc_group_uris <- sapply(c("X", "obs", "var"), \(x) file.path(data_dir, x))
```

## RNA Counts

Create a new instance of `SCGroup_X` and specify its location.

```{r}
if (tiledb_vfs_is_dir(sc_group_uris[["X"]])) {
  tiledb_vfs_remove_dir(sc_group_uris[["X"]])
}

scgroup_x <- SCGroup_X$new(array_uri = sc_group_uris[["X"]])
```

Ingest RNA counts from the `SeruatObject` into the `X` component of a TileDB `sc_group`. While the higher-level The higher-level `SCGroup` class will provide convenience functions that accept `Seurat` objects directly and then pass the individual

```{r}
scgroup_x$from_matrix(
  x = GetAssayData(object = pbmc.rna, slot = "counts")
)
```

## Feature (variable) annotations

Create an instance of `SCGroup_Annotation` for the variable annotations:

```{r}
if (tiledb_vfs_is_dir(sc_group_uris[["var"]])) {
  tiledb_vfs_remove_dir(sc_group_uris[["var"]])
}

scgroup_var <- SCGroup_Annotation$new(array_uri = sc_group_uris[["var"]])
```

Ingest `data.frame` containing the RNA assay's feature annotations into the `var` array.

```{r}
scgroup_var$from_dataframe(
  x = GetAssay(pbmc.rna, assay = "RNA")[[]]
)
```


## Observation (sample) annotations

Create a second instance of `SCGroup_Annotation` for the observation annotations:

```{r}
scgroup_obs_uri <- file.path(data_dir, "obs")
scgroup_obs <- SCGroup_Annotation$new(array_uri = scgroup_obs_uri)
```

Ingest `data.frame` containing observation annotations into the `obs` component.

```{r}
scgroup_obs$from_dataframe(
  x = pbmc.rna[[]]
)
```

Check out contents of test data directory:

```{r}
dir(data_dir, recursive = TRUE)
```

# Convert Seurat object to TileDB-backed sc_group

Create the empty group:

```{r}
scgroup_uri <- file.path(data_dir, "sc_group")

if (tiledb_vfs_is_dir(scgroup_uri)) {
  tiledb_vfs_remove_dir(scgroup_uri)
}

scgroup <- SCGroup$new(array_uri = scgroup_uri)
```


Ingest the RNA assay (including feature annotations) and observation annotations from a Seurat object into the TileDB-backed `sc_group`:

```{r}
scgroup$from_seurat(object = pbmc.rna, assay = "RNA")
```

# Load Seurat object from TileDB-backed `sc_group`

Create new instance of `SCGroup` that discovers the existing group of TileDB arrays:

```{r}
scgroup <- SCGroup$new(array_uri = scgroup_uri)
```

Load the data into memory and create a Seurat `Assay` object:

```{r}
scgroup$to_seurat_assay()
```

# Session

```{r}
sessionInfo()
```

```{r cleanup, include=FALSE, eval=params$cleanup}
tiledb::tiledb_vfs_remove_dir(tdb_brain$array_uri)
```
