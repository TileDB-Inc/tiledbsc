---
title: "Converting HDF5 files from 10x Genomics"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{HDF5 10X Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Setup

```{r setup}
library(tiledbsc)
h5_url <- "https://cf.10xgenomics.com/samples/cell-exp/6.1.0/500_PBMC_3p_LT_Chromium_X/500_PBMC_3p_LT_Chromium_X_filtered_feature_bc_matrix.h5"
```

In this vignette we'll work with a small example dataset provided by 10x Genomics containing ~500 Human peripheral blood mononuclear cells (PBMCs). More information about this data is available [here](https://www.10xgenomics.com/resources/datasets/500-human-pbm-cs-3-lt-v-3-1-chromium-x-3-1-low-6-1-0).

Let's download a local of the HDF5 file.

```{r}
h5_file <- basename(h5_url)
download.file(h5_url, dest = h5_file)
```

## Conversion

Use `tiledbsc`'s conversion function to create a TileDB array containing the same data.

```{r}
tdb_uri <- H510xToTiledb(source = h5_file, overwrite = TRUE, tile_order = "COL_MAJOR")
tdb_uri
```

This created a new directory in your current working directory named `r tdb_uri`, which contains the TileDB array.

```{r}
dir(tdb_uri)
```

## Querying

We can use the tiledb package to slice the array without loading the entire dataset into memory.

Open the array:

```{r}
tdb_array <- tiledb_array(tdb_uri, return_as = "tibble")
```

Use standard R indexing to slice by feature

```{r}
tdb_array["B2M", ]
```

or barcode:

```{r}
tdb_array[, "AATCACGGTCTTCATT-1"]
```


You can also retrieve counts for multiple genes across all barcodes:

```{r}
# specify genes of interest
genes <- c("B2M", "EEF1A1", "IGKC", "MALAT1", "MT-ATP6", "MT-CO1")
selected_ranges(tdb_array) <- list(feature = cbind(genes, genes))

# run the query
tbl_counts <- tdb_array[]

boxplot(data ~ feature, data = tbl_counts, col = "skyblue", pch = 16)
```


## Session

```{r}
sessionInfo()
```


```{r cleanup, include=FALSE}
unlink(array_uri, recursive = TRUE)
unlink(h5_file)
```

